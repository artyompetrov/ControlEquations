using System;
using System.Collections.Generic;
using System.Text;
using Xunit;
using FluentAssertions;

namespace ControlEquations.Tests
{
    public class LineActivePowerBalanceEquationTests : ControlEquationTestsParent
    {
        [Theory]
        [InlineData(231.2044627408080, -35.500069949697900000, -15.257230117008000, 35.6245984296235000, 4.9560000000000, 0.0)]
        [InlineData(238.0753080504870, -0.047983178363384800, 15.759204079531100, 0.1018332836628560, 5.6640000000000, 0.0)]
        [InlineData(10.5000000000000, 6.013636363747720000, 2.476641851251380, -6.013636363747720, 0.0000000000000, 0.0)]
        [InlineData(10.5000000000000, 9.545454513788160000, 3.923421457940350, -9.5454545137881600, 0.0000000000000, 0.0)]
        [InlineData(10.5000000000000, 9.545454513788660000, 3.923421457940330, -9.5454545137886600, 0.0000000000000, 0.0)]
        [InlineData(229.1396044288090, 29.217292074783900000, 15.837860187597900, -29.1581749428831000, 2.8103000000000, 0.0)]
        [InlineData(231.2044627408080, 29.325797266314200000, 7.915036372968530, -29.2172048618556000, 5.7600000000000, 0.0)]
        [InlineData(236.0064239947610, 29.744901363550300000, 16.565546379236500, -29.6864212465134000, 2.8100000000000, 0.0)]
        [InlineData(238.0753080504870, 29.851609344602400000, 8.125288918941950, -29.7448585688691000, 5.7600000000000, 0.0)]
        [InlineData(237.0610043603280, 47.863883953747200000, 14.517701450996700, -47.5921619709658000, 5.7600000000000, 0.0)]
        [InlineData(238.0753080504870, 75.032638957739700000, 12.248060481532300, -74.8870154990013000, 1.4160000000000, 0.0)]
        [InlineData(237.0610043603280, 83.632121429182800000, 20.007865857073800, -83.1533321012868000, 3.5400000000000, 0.0)]
        [InlineData(234.2112072851630, 94.891775466257500000, 51.746686737246400, -94.7817577748328000, 0.5166000000000, 0.0)]
        [InlineData(234.2112072851630, 94.891826899358600000, 51.746486470780500, -94.7810852310592000, 0.5200000000000, 0.0)]
        [InlineData(240.5738042396820, 96.176042166773800000, 11.455998362940900, -94.9907030083688000, 7.0800000000000, 0.0)]
        [InlineData(525.0000000000000, 192.376147256135000000, 28.356693804992500, -192.3635807550370000, 0.0916000000000, 0.0)]
        [InlineData(220.000000000000000, 323.578753500602000, 61.252362068131600, -323.578753500602000, 0.000000000000000, 0.0)]
        [InlineData(109.533975705353000, 28.337292675732900, -50.266249803021700, -27.550689268997100, 2.800000000000000, 0.0)]
        [InlineData(109.533975705353000, 16.868745973526500, -29.472386374972200, -16.533725523454900, 3.400000000000000, 0.0)]
        [InlineData(112.271616381548000, 16.533775646872500, -31.636345233026100, -16.401084611524300, 1.300000000000000, 0.0)]
        [InlineData(219.973095035742000, 238.166130717608000, 26.139244871660300, -236.743812166467000, 1.200000000000000, 0.0)]
        [InlineData(113.360695416382000, 31.279405889152200, -28.161629023915600, -31.113031660849300, 1.200000000000000, 0.0)]
        [InlineData(117.439981790432000, 44.983644450952600, 41.034841642489300, -44.291312990457600, 2.600000000000000, 0.0)]
        [InlineData(116.338722896416000, 25.159334045461700, 23.786944633240500, -24.873143536712500, 3.300000000000000, 0.0)]
        [InlineData(116.338722896416000, -16.921090578971400, -13.300044677766600, 16.990815067460400, 2.000000000000000, 0.0)]
        [InlineData(116.338722896416000, 8.682836409890560, 2.813159724952840, -8.674943767652210, 1.300000000000000, 0.0)]
        [InlineData(113.360695416382000, -20.073063583281000, -19.442762803260600, 20.291572188840400, 3.500000000000000, 0.0)]
        [InlineData(117.439981790432000, 9.667711009158440, 7.419245438782960, -9.620814356929530, 4.700000000000000, 0.0)]
        [InlineData(218.025725003026000, 196.922894805134000, -3.449564282240570, -194.636648154636000, 2.800000000000000, 0.0)]
        [InlineData(216.411511060623000, -191.515767408809000, 45.849676519411700, 194.638727039165000, 3.800000000000000, 0.0)]
        [InlineData(117.131081802059000, 2.029388852130470, 14.097182162802200, -1.995779695644400, 2.400000000000000, 0.0)]
        [InlineData(117.246349590339000, -36.204790466349000, 7.389199750530810, 36.373157761279100, 1.700000000000000, 0.0)]
        [InlineData(117.104008400468000, -35.995546364229600, 8.810419492324560, 36.204931745988800, 2.100000000000000, 0.0)]
        [InlineData(117.104008400468000, 10.175964274185700, 43.699077749308800, -9.858110110293540, 2.200000000000000, 0.0)]
        [InlineData(117.131081802059000, -2.029339206091900, -14.097169059894000, 2.049130509402880, 1.300000000000000, 0.0)]
        [InlineData(117.703368120197000, 11.817891571889700, 0.540144222746879, -11.732778245753800, 8.400000000000000, 0.0)]
        [InlineData(227.445272184857000, 128.683714634372000, 49.057412835137400, -126.823752230623000, 5.200000000000000, 0.0)]
        [InlineData(216.411511060623000, -34.577604584884000, -55.294854846617700, 35.223185442851800, 6.200000000000000, 0.0)]
        [InlineData(213.258160572008000, -197.518844366925000, -33.170989498969300, 200.087513277078000, 2.900000000000000, 0.0)]
        [InlineData(107.691333206789000, 52.934225416492500, 24.327472411392700, -51.917086341359900, 3.500000000000000, 0.0)]
        [InlineData(103.402230307766000, -5.875778055626910, 6.052672993116470, 5.899635453525670, 3.900000000000000, 0.0)]
        [InlineData(216.400962949904000, 104.430172755943000, 13.452822633838800, -103.280172249335000, 4.900000000000000, 0.0)]
        [InlineData(213.258160572008000, 247.730492031531000, 0.236080056489158, -246.920838296908000, 0.600000000000000, 0.0)]
        [InlineData(465.245569634028000, -48.097232449154500, 69.956608507718000, 48.158455047677500, 5.700000000000000, 0.0)]
        [InlineData(223.528912936278000, 257.710507631421000, 167.506263260043000, -255.075402695498000, 1.400000000000000, 0.0)]
        [InlineData(223.528912936278000, 136.977647837045000, 80.981672883835000, -134.277824589400000, 5.500000000000000, 0.0)]
        [InlineData(210.184133168948000, 36.463010643617800, -20.243123244190100, -36.211485792672300, 5.700000000000000, 0.0)]
        [InlineData(213.175645649593000, 46.811842000251200, 22.017077149539200, -46.771030687746800, 0.700000000000000, 0.0)]
        [InlineData(212.949059662656000, -50.026465794218600, -0.390768191665897, 50.120407459036800, 1.700000000000000, 0.0)]
        [InlineData(215.475597906664000, 50.373599600559500, 12.650542064211400, -50.119996105745300, 4.500000000000000, 0.0)]
        [InlineData(215.475597906664000, -164.584698518103000, 28.361800439959400, 166.734610323858000, 3.600000000000000, 0.0)]
        [InlineData(112.025633943121000, -102.241354595209000, -9.322747378930370, 105.688721483461000, 4.100000000000000, 0.0)]
        [InlineData(213.483461175009000, -54.423754870005900, -5.371021259862460, 54.683684300661700, 3.900000000000000, 0.0)]
        [InlineData(213.483461175009000, 54.907056245588200, 3.816177107179590, -54.794386718162500, 1.700000000000000, 0.0)]
        [InlineData(116.540068133706000, 29.658121719638100, 17.910802354217400, -29.439772910655700, 2.500000000000000, 0.0)]
        [InlineData(111.383795715553000, -58.123507271736000, -29.431425213436400, 58.879664371373900, 2.200000000000000, 0.0)]
        [InlineData(109.273818844966000, -37.621138860562600, -15.327501158048900, 37.968939948401100, 2.500000000000000, 0.0)]
        [InlineData(109.273818844966000, 12.781618372220200, 7.466258673690900, -12.750914112425200, 1.700000000000000, 0.0)]
        [InlineData(108.699165106138000, -7.098799455202780, -4.883478065700310, 7.114560638204230, 2.400000000000000, 0.0)]
        [InlineData(212.949059662656000, 73.482319046977700, -12.659646992400300, -73.147558714729600, 2.700000000000000, 0.0)]
        [InlineData(110.435086686640000, 28.783272299000000, 14.297054199537900, -28.640244940395400, 1.700000000000000, 0.0)]
        [InlineData(110.435086686640000, -80.085511251857400, 7.292381366469050, 81.515945907245500, 2.700000000000000, 0.0)]
        [InlineData(110.435086686640000, 15.723381442874300, 7.541704650399610, -15.642990746024400, 3.300000000000000, 0.0)]
        [InlineData(222.199960766075000, 36.645731375862800, 13.685503778015700, -36.630234969517700, 0.500000000000000, 0.0)]
        [InlineData(221.457538299056000, -31.252960154701300, 38.575706128920800, 31.278089229639500, 0.500000000000000, 0.0)]
        [InlineData(465.196463238894000, -24.043758780698400, 34.975436772682000, 24.051666604437300, 0.950000000000000, 0.0)]
        [InlineData(215.475597906664000, 29.764523382005800, -27.301554712459700, -29.746955956714200, 0.500000000000000, 0.0)]
        public void LineActivePowerBalanceEquation_ErrorCalculation(double Ui, double Pij, double Qij, double Pji, double r, double error)
        {
            var ui = Argument<Voltage>(Ui);
            var pij = Argument<ActivePower>(Pij);
            var eq = new LineActivePowerBalanceEquation(ui, pij,
                Argument<ReactivePower>(Qij), Argument<ActivePower>(Pji), new Constant(r));

            Assert.InRange(eq.Error, error - 0.2 , error + 0.2);
            var specificRangeWidth = new Dictionary<EquationArgument, double>();
            specificRangeWidth.Add(ui, 10);
            specificRangeWidth.Add(pij, 1);

            var specificSkipNan = new Dictionary<EquationArgument, bool>();
            specificSkipNan.Add(ui, true);

            RearrangeEquationTest(eq, true, specificRangeWidth: specificRangeWidth, specificSkipNaN: specificSkipNan);
        }
    }
}
